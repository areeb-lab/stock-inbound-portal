<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleek-Inbound</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0e1117;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 { font-size: 2.5rem; }
        .header p { color: #888; margin-top: 10px; }
        .container { max-width: 600px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        select, button {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
        }
        select { background: #1e3a5f; color: white; }
        .info-box {
            background: #1e3a5f;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .info-box.category { border-left: 4px solid #4CAF50; }
        .info-box.vendor { border-left: 4px solid #E67E22; }
        .btn-primary {
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .btn-secondary {
            background: #3498db;
            color: white;
            cursor: pointer;
            margin-top: 10px;
        }
        video, img { width: 100%; border-radius: 10px; margin: 10px 0; }
        .scorecard {
            display: flex;
            align-items: center;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .donut {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .donut-inner {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #0e1117;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .donut-inner .total { font-size: 2rem; font-weight: bold; }
        .donut-inner .label { color: #888; font-size: 0.8rem; }
        .stats div { margin: 5px 0; }
        .orange { color: #E67E22; }
        .green { color: #27AE60; }
        .hidden { display: none; }
        .success { background: #27AE60; padding: 15px; border-radius: 10px; text-align: center; margin: 10px 0; }
        .error { background: #e74c3c; padding: 15px; border-radius: 10px; text-align: center; margin: 10px 0; }
        #history-section { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #1e3a5f; }
        .row { display: flex; gap: 10px; }
        .row > div { flex: 1; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöö Fleek-Inbound üì¶</h1>
        <p>Jahan Vintage Wahan Fleek</p>
    </div>

    <div class="scorecard">
        <div class="donut" id="donut">
            <div class="donut-inner">
                <span class="total" id="total">0</span>
                <span class="label">Total</span>
            </div>
        </div>
        <div class="stats">
            <div class="orange"><strong>üü† PICKUP_READY</strong><br><span id="pickup">0</span></div>
            <div class="green"><strong>üü¢ INBOUND_DONE</strong><br><span id="inbound">0</span></div>
        </div>
    </div>

    <div class="container">
        <h2>üìù New Stock Entry</h2>
        
        <div class="form-group">
            <label>Order Number *</label>
            <select id="orderSelect">
                <option value="">Select order number...</option>
            </select>
        </div>

        <div class="row" id="infoRow" style="display:none;">
            <div>
                <div class="info-box category">
                    <strong>üì¶ Category:</strong><br>
                    <span id="categoryDisplay"></span>
                </div>
            </div>
            <div>
                <div class="info-box vendor">
                    <strong>üè™ Vendor:</strong><br>
                    <span id="vendorDisplay"></span>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>üì∑ Stock Image</label>
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" class="hidden"></canvas>
            <img id="preview" class="hidden">
            <button type="button" class="btn-secondary" id="captureBtn">üì∏ Capture Photo</button>
            <button type="button" class="btn-secondary hidden" id="retakeBtn">üîÑ Retake</button>
        </div>

        <div id="message"></div>

        <button class="btn-primary" id="saveBtn">üöö Chalo Inbound Mai</button>
        <button class="btn-secondary" id="historyBtn">üìú History</button>

        <div id="history-section" class="hidden">
            <h3>üìú Today's History</h3>
            <table id="historyTable">
                <thead>
                    <tr><th>Time</th><th>Order</th><th>Category</th><th>Vendor</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <audio id="beep" src="https://www.soundjay.com/buttons/beep-01a.mp3"></audio>

    <script>
        let orders = [];
        let selectedOrder = null;
        let capturedImage = null;

        // Load orders
        async function loadOrders() {
            try {
                const res = await fetch('/api/orders');
                const data = await res.json();
                if (data.success) {
                    orders = data.orders;
                    const select = document.getElementById('orderSelect');
                    orders.forEach(o => {
                        const opt = document.createElement('option');
                        opt.value = o.id;
                        opt.textContent = o.id;
                        select.appendChild(opt);
                    });
                }
            } catch (e) { console.error(e); }
        }

        // Load scorecard
        async function loadScorecard() {
            try {
                const res = await fetch('/api/scorecard');
                const data = await res.json();
                if (data.success) {
                    const pickup = data.pickup_ready;
                    const inbound = data.inbound_done;
                    const total = pickup + inbound;
                    document.getElementById('pickup').textContent = `${pickup} (${total ? ((pickup/total)*100).toFixed(1) : 0}%)`;
                    document.getElementById('inbound').textContent = `${inbound} (${total ? ((inbound/total)*100).toFixed(1) : 0}%)`;
                    document.getElementById('total').textContent = total;
                    
                    const pickupPct = total ? (pickup / total) * 100 : 0;
                    document.getElementById('donut').style.background = 
                        `conic-gradient(#E67E22 0deg ${pickupPct * 3.6}deg, #27AE60 ${pickupPct * 3.6}deg 360deg)`;
                }
            } catch (e) { console.error(e); }
        }

        // Order select change
        document.getElementById('orderSelect').addEventListener('change', function() {
            const id = this.value;
            if (id) {
                selectedOrder = orders.find(o => o.id === id);
                document.getElementById('categoryDisplay').textContent = selectedOrder.category || 'N/A';
                document.getElementById('vendorDisplay').textContent = selectedOrder.vendor || 'N/A';
                document.getElementById('infoRow').style.display = 'flex';
            } else {
                selectedOrder = null;
                document.getElementById('infoRow').style.display = 'none';
            }
        });

        // Camera - BACK CAMERA
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { exact: "environment" } }
                });
                document.getElementById('video').srcObject = stream;
            } catch (e) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" }
                    });
                    document.getElementById('video').srcObject = stream;
                } catch (e2) {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    document.getElementById('video').srcObject = stream;
                }
            }
        }

        // Capture photo
        document.getElementById('captureBtn').addEventListener('click', function() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const preview = document.getElementById('preview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            capturedImage = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
            preview.src = canvas.toDataURL('image/jpeg', 0.7);
            
            video.classList.add('hidden');
            preview.classList.remove('hidden');
            this.classList.add('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
        });

        // Retake
        document.getElementById('retakeBtn').addEventListener('click', function() {
            capturedImage = null;
            document.getElementById('video').classList.remove('hidden');
            document.getElementById('preview').classList.add('hidden');
            document.getElementById('captureBtn').classList.remove('hidden');
            this.classList.add('hidden');
            startCamera();
        });

        // Save
        document.getElementById('saveBtn').addEventListener('click', async function() {
            const msg = document.getElementById('message');
            
            if (!selectedOrder) {
                msg.innerHTML = '<div class="error">Please select an order!</div>';
                return;
            }
            if (!capturedImage) {
                msg.innerHTML = '<div class="error">Please capture an image!</div>';
                return;
            }

            this.disabled = true;
            this.textContent = 'Saving...';

            try {
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_number: selectedOrder.id,
                        category: selectedOrder.category,
                        vendor: selectedOrder.vendor,
                        image_b64: capturedImage
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('beep').play();
                    msg.innerHTML = '<div class="success">‚úÖ Record saved successfully!</div>';
                    
                    // Reset form
                    document.getElementById('orderSelect').value = '';
                    document.getElementById('infoRow').style.display = 'none';
                    selectedOrder = null;
                    capturedImage = null;
                    document.getElementById('video').classList.remove('hidden');
                    document.getElementById('preview').classList.add('hidden');
                    document.getElementById('captureBtn').classList.remove('hidden');
                    document.getElementById('retakeBtn').classList.add('hidden');
                    startCamera();
                    loadScorecard();
                    
                    setTimeout(() => msg.innerHTML = '', 3000);
                } else {
                    msg.innerHTML = `<div class="error">${data.error}</div>`;
                }
            } catch (e) {
                msg.innerHTML = `<div class="error">${e.message}</div>`;
            }

            this.disabled = false;
            this.textContent = 'üöö Chalo Inbound Mai';
        });

        // History toggle
        document.getElementById('historyBtn').addEventListener('click', async function() {
            const section = document.getElementById('history-section');
            if (section.classList.contains('hidden')) {
                const res = await fetch('/api/history');
                const data = await res.json();
                if (data.success) {
                    const tbody = document.querySelector('#historyTable tbody');
                    tbody.innerHTML = '';
                    data.records.forEach(r => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${r.Date || r.date || ''}</td><td>${r.Order || r.order_number || ''}</td><td>${r.Category || r.category || ''}</td><td>${r.Vendor || r.vendor || ''}</td>`;
                        tbody.appendChild(tr);
                    });
                }
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        });

        // Init
        loadOrders();
        loadScorecard();
        startCamera();
    </script>
</body>
</html>
