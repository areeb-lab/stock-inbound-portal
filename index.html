<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ğŸšš Fleek-Inbound ğŸ“¦</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', sans-serif;
    background: #0e1117;
    color: #e0e0e0;
    min-height: 100vh;
  }

  /* â”€â”€ HEADER â”€â”€ */
  .header-wrap {
    display: grid;
    grid-template-columns: 2fr 1.5fr;
    gap: 16px;
    padding: 20px 24px 0;
  }

  .main-header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    padding: 30px 40px;
    border-radius: 15px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  .header-title {
    font-size: 2.4rem;
    font-weight: bold;
    color: white;
  }
  .header-subtitle {
    color: #888;
    font-size: 1rem;
    margin-top: 6px;
  }

  /* â”€â”€ SCORECARD â”€â”€ */
  .scorecard {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 15px;
    padding: 20px 25px;
    display: flex;
    align-items: center;
    gap: 24px;
  }

  .donut-wrap {
    position: relative;
    width: 160px;
    height: 160px;
    flex-shrink: 0;
  }
  .donut-ring {
    width: 160px;
    height: 160px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.5s ease;
  }
  .donut-hole {
    width: 110px;
    height: 110px;
    border-radius: 50%;
    background: #0e1117;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .donut-total {
    color: white;
    font-size: 2rem;
    font-weight: bold;
    line-height: 1;
  }
  .donut-label {
    color: #888;
    font-size: 0.75rem;
    margin-top: 3px;
  }

  .legend-item { margin-bottom: 14px; }
  .legend-item:last-child { margin-bottom: 0; }
  .legend-title { font-weight: bold; font-size: 0.95rem; }
  .legend-count { font-size: 1.3rem; font-weight: bold; }
  .legend-pct { font-size: 0.82rem; opacity: 0.8; }
  .orange { color: #E67E22; }
  .green  { color: #27AE60; }

  /* â”€â”€ FORM SECTION â”€â”€ */
  .form-outer {
    display: flex;
    justify-content: center;
    padding: 28px 24px;
  }
  .form-inner {
    width: 100%;
    max-width: 620px;
    background: #1a1a2e;
    border-radius: 15px;
    padding: 30px;
  }

  .section-title {
    font-size: 1.15rem;
    font-weight: bold;
    color: white;
    margin-bottom: 12px;
  }

  /* Selectbox */
  .select-wrap { position: relative; margin-bottom: 18px; }
  .select-wrap label {
    display: block;
    font-size: 0.85rem;
    color: #aaa;
    margin-bottom: 6px;
  }
  select {
    width: 100%;
    padding: 12px 16px;
    background: #0e1117;
    color: #e0e0e0;
    border: 1px solid #2a3a5c;
    border-radius: 8px;
    font-size: 1rem;
    appearance: none;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
  }
  select:focus { border-color: #4CAF50; }
  .select-arrow {
    position: absolute;
    right: 14px;
    top: 38px;
    color: #888;
    pointer-events: none;
  }

  /* Category & Vendor boxes */
  .cv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px; }
  .info-box {
    background: #0e1117;
    padding: 14px;
    border-radius: 10px;
  }
  .info-box.category { border-left: 4px solid #4CAF50; }
  .info-box.vendor   { border-left: 4px solid #E67E22; }
  .info-box small { font-size: 0.72rem; font-weight: bold; letter-spacing: 0.5px; display: block; margin-bottom: 4px; }
  .info-box.category small { color: #4CAF50; }
  .info-box.vendor   small { color: #E67E22; }
  .info-box span { font-size: 0.95rem; color: #e0e0e0; }

  /* Radio */
  .radio-group {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
  }
  .radio-btn {
    flex: 1;
    padding: 10px;
    background: #0e1117;
    border: 2px solid #2a3a5c;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    color: #aaa;
    font-size: 0.95rem;
    transition: all 0.2s;
    user-select: none;
  }
  .radio-btn.active {
    border-color: #4CAF50;
    color: #4CAF50;
    background: #0a1f0a;
  }

  /* Image input areas */
  .img-area { margin-bottom: 16px; }
  #camera-section, #upload-section { display: none; }
  #camera-section.show, #upload-section.show { display: block; }

  video {
    width: 100%;
    border-radius: 10px;
    background: #000;
  }
  canvas { display: none; }

  .cam-btn {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    background: #1e3a5f;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  .cam-btn:hover { background: #2a4a7f; }
  .cam-btn.retake { background: #5a2a1f; }
  .cam-btn.retake:hover { background: #7a3a2f; }

  .file-drop {
    border: 2px dashed #2a3a5c;
    border-radius: 10px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s;
    color: #888;
  }
  .file-drop:hover { border-color: #4CAF50; color: #4CAF50; }
  .file-drop input { display: none; }

  /* Preview */
  .preview-wrap {
    margin-bottom: 16px;
    display: none;
  }
  .preview-wrap.show { display: block; }
  .preview-wrap img {
    width: 100%;
    border-radius: 10px;
    max-height: 300px;
    object-fit: contain;
    background: #0e1117;
  }

  /* Buttons */
  .btn-save {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #4CAF50, #388E3C);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.2rem;
    font-weight: bold;
    cursor: pointer;
    transition: opacity 0.2s;
    margin-bottom: 12px;
  }
  .btn-save:hover { opacity: 0.9; }
  .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-history {
    width: 100%;
    padding: 12px;
    background: #1e3a5f;
    color: white;
    border: 1px solid #3a5a8f;
    border-radius: 10px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-history:hover { background: #2a4a7f; }

  /* Toast */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 14px 22px;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: bold;
    z-index: 9999;
    opacity: 0;
    transform: translateX(60px);
    transition: all 0.3s ease;
    max-width: 320px;
  }
  .toast.show { opacity: 1; transform: translateX(0); }
  .toast.success { background: #1a4a1a; border: 1px solid #4CAF50; color: #4CAF50; }
  .toast.error   { background: #4a1a1a; border: 1px solid #e74c3c; color: #e74c3c; }

  /* Spinner */
  .spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 3px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* History Section */
  .history-section {
    padding: 0 24px 30px;
    display: none;
  }
  .history-section.show { display: block; }
  .history-title {
    font-size: 1.2rem;
    font-weight: bold;
    color: white;
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid #2a3a5c;
  }

  .history-table-wrap { overflow-x: auto; border-radius: 10px; }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #1a1a2e;
    border-radius: 10px;
    overflow: hidden;
  }
  th {
    background: #16213e;
    color: #aaa;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 12px 16px;
    text-align: left;
  }
  td {
    padding: 12px 16px;
    border-bottom: 1px solid #1e2e4a;
    font-size: 0.9rem;
    color: #e0e0e0;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #1e2e4a; }

  td.img-cell img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer;
  }

  .no-records {
    text-align: center;
    padding: 40px;
    color: #888;
    background: #1a1a2e;
    border-radius: 10px;
  }

  /* Loading overlay */
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9998;
    flex-direction: column;
    gap: 14px;
  }
  .loading-overlay.show { display: flex; }
  .loading-text { color: white; font-size: 1rem; }

  /* Responsive */
  @media (max-width: 768px) {
    .header-wrap { grid-template-columns: 1fr; }
    .cv-grid { grid-template-columns: 1fr; }
    .scorecard { flex-direction: column; align-items: flex-start; }
  }
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner" style="width:40px;height:40px;border-width:4px;"></div>
  <div class="loading-text" id="loadingText">Saving...</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Beep Audio -->
<audio id="beepAudio" preload="auto">
  <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
</audio>

<!-- â”€â”€ HEADER â”€â”€ -->
<div class="header-wrap">
  <div class="main-header">
    <div class="header-title">ğŸšš Fleek-Inbound ğŸ“¦</div>
    <div class="header-subtitle">Jahan Vintage Wahan Fleek</div>
  </div>
  <div class="scorecard">
    <div class="donut-wrap">
      <div class="donut-ring" id="donutRing">
        <div class="donut-hole">
          <span class="donut-total" id="donutTotal">â€“</span>
          <span class="donut-label">Total</span>
        </div>
      </div>
    </div>
    <div>
      <div class="legend-item">
        <div class="legend-title orange">ğŸŸ  PICKUP_READY</div>
        <div>
          <span class="legend-count orange" id="pickupCount">â€“</span>
          <span class="legend-pct orange" id="pickupPct"></span>
        </div>
      </div>
      <div class="legend-item">
        <div class="legend-title green">ğŸŸ¢ INBOUND_DONE</div>
        <div>
          <span class="legend-count green" id="inboundCount">â€“</span>
          <span class="legend-pct green" id="inboundPct"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ FORM â”€â”€ -->
<div class="form-outer">
  <div class="form-inner">

    <div class="section-title">ğŸ“ New Stock Entry</div>

    <!-- Order Number -->
    <div class="select-wrap">
      <label>Order Number *</label>
      <select id="orderSelect">
        <option value="">Select order number...</option>
      </select>
      <span class="select-arrow">â–¾</span>
    </div>

    <!-- Category & Vendor -->
    <div class="cv-grid" id="cvGrid" style="display:none;">
      <div class="info-box category">
        <small>ğŸ“¦ CATEGORY</small>
        <span id="categoryVal">â€“</span>
      </div>
      <div class="info-box vendor">
        <small>ğŸª VENDOR</small>
        <span id="vendorVal">â€“</span>
      </div>
    </div>

    <!-- Image Section -->
    <div class="section-title" style="margin-top:8px;">ğŸ“· Stock Image</div>

    <div class="radio-group">
      <div class="radio-btn active" id="radioCamera" onclick="switchMode('camera')">ğŸ“· Take Photo</div>
      <div class="radio-btn" id="radioUpload" onclick="switchMode('upload')">ğŸ“ Upload Photo</div>
    </div>

    <!-- Camera -->
    <div class="img-area" id="camera-section" class="show">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
      <button class="cam-btn" id="captureBtn" onclick="capturePhoto()">ğŸ“¸ Capture Photo</button>
    </div>

    <!-- Upload -->
    <div class="img-area" id="upload-section">
      <div class="file-drop" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)"/>
        <div style="font-size:2rem; margin-bottom:8px;">ğŸ“</div>
        <div>Click to upload or drag & drop</div>
        <div style="font-size:0.8rem; margin-top:4px;">JPG, JPEG, PNG</div>
      </div>
    </div>

    <!-- Preview -->
    <div class="preview-wrap" id="previewWrap">
      <img id="previewImg" src="" alt="Preview"/>
      <button class="cam-btn retake" id="retakeBtn" onclick="retakePhoto()" style="margin-top:8px;">ğŸ”„ Retake / Change</button>
    </div>

    <br/>

    <!-- Save Button -->
    <button class="btn-save" id="saveBtn" onclick="saveRecord()">ğŸšš Chalo Inbound Mai</button>

    <!-- History Button -->
    <button class="btn-history" id="historyBtn" onclick="toggleHistory()">ğŸ“œ History</button>

  </div>
</div>

<!-- â”€â”€ HISTORY â”€â”€ -->
<div class="history-section" id="historySection">
  <div class="history-title">ğŸ“œ Today's Inbound History</div>
  <div id="historyContent">
    <div class="no-records">Loading...</div>
  </div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ordersData   = {};
let capturedBlob = null;
let currentMode  = 'camera';
let stream       = null;
let historyVisible = false;

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  loadOrders();
  loadScorecard();
  startCamera();
});

// â”€â”€â”€ API Calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOrders() {
  try {
    const res  = await fetch('/api/orders');
    const data = await res.json();
    if (!data.success) throw new Error(data.error);

    const select = document.getElementById('orderSelect');
    data.orders.forEach(o => {
      ordersData[o.id] = { category: o.category, vendor: o.vendor };
      const opt = document.createElement('option');
      opt.value = o.id;
      opt.textContent = o.id;
      select.appendChild(opt);
    });
  } catch(e) {
    showToast('Error loading orders: ' + e.message, 'error');
  }
}

async function loadScorecard() {
  try {
    const res  = await fetch('/api/scorecard');
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    updateDonut(data.pickup_ready, data.inbound_done);
  } catch(e) {
    console.error('Scorecard error:', e);
  }
}

// â”€â”€â”€ Donut Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDonut(pickup, inbound) {
  const total = pickup + inbound;
  const pickupPct  = total > 0 ? (pickup  / total * 100) : 50;
  const inboundPct = total > 0 ? (inbound / total * 100) : 50;
  const deg = pickupPct * 3.6;

  document.getElementById('donutRing').style.background =
    `conic-gradient(#E67E22 0deg ${deg.toFixed(2)}deg, #27AE60 ${deg.toFixed(2)}deg 360deg)`;

  document.getElementById('donutTotal').textContent    = total;
  document.getElementById('pickupCount').textContent   = pickup;
  document.getElementById('inboundCount').textContent  = inbound;
  document.getElementById('pickupPct').textContent     = ` (${pickupPct.toFixed(1)}%)`;
  document.getElementById('inboundPct').textContent    = ` (${inboundPct.toFixed(1)}%)`;
}

// â”€â”€â”€ Order Select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('orderSelect').addEventListener('change', function() {
  const val  = this.value;
  const grid = document.getElementById('cvGrid');
  if (val && ordersData[val]) {
    document.getElementById('categoryVal').textContent = ordersData[val].category || 'â€“';
    document.getElementById('vendorVal').textContent   = ordersData[val].vendor   || 'â€“';
    grid.style.display = 'grid';
  } else {
    grid.style.display = 'none';
  }
});

// â”€â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    document.getElementById('video').srcObject = stream;
    document.getElementById('camera-section').classList.add('show');
  } catch(e) {
    // Camera not available, switch to upload
    switchMode('upload');
    document.getElementById('radioCamera').style.display = 'none';
  }
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
}

function capturePhoto() {
  const video  = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  canvas.width  = video.videoWidth  || 800;
  canvas.height = video.videoHeight || 600;
  canvas.getContext('2d').drawImage(video, 0, 0);

  canvas.toBlob(blob => {
    capturedBlob = blob;
    showPreview(URL.createObjectURL(blob));
    stopCamera();
    document.getElementById('camera-section').classList.remove('show');
  }, 'image/jpeg', 0.9);
}

// â”€â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  capturedBlob = file;
  showPreview(URL.createObjectURL(file));
}

// â”€â”€â”€ Mode Switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchMode(mode) {
  currentMode = mode;
  capturedBlob = null;
  hidePreview();

  document.getElementById('radioCamera').classList.toggle('active', mode === 'camera');
  document.getElementById('radioUpload').classList.toggle('active', mode === 'upload');

  const camSec = document.getElementById('camera-section');
  const upSec  = document.getElementById('upload-section');

  if (mode === 'camera') {
    upSec.classList.remove('show');
    camSec.classList.add('show');
    startCamera();
  } else {
    camSec.classList.remove('show');
    upSec.classList.add('show');
    stopCamera();
  }
}

// â”€â”€â”€ Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPreview(url) {
  document.getElementById('previewImg').src = url;
  document.getElementById('previewWrap').classList.add('show');
  document.getElementById('upload-section').classList.remove('show');
}

function hidePreview() {
  document.getElementById('previewWrap').classList.remove('show');
  document.getElementById('previewImg').src = '';
  capturedBlob = null;
}

function retakePhoto() {
  hidePreview();
  if (currentMode === 'camera') {
    document.getElementById('camera-section').classList.add('show');
    startCamera();
  } else {
    document.getElementById('upload-section').classList.add('show');
    document.getElementById('fileInput').value = '';
  }
}

// â”€â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveRecord() {
  const order = document.getElementById('orderSelect').value;
  if (!order) { showToast('âŒ Please select an order number!', 'error'); return; }
  if (!capturedBlob) { showToast('âŒ Please capture or upload an image!', 'error'); return; }

  const category = ordersData[order]?.category || '';
  const vendor   = ordersData[order]?.vendor   || '';

  // Compress image
  showLoading('Uploading image...');
  const b64 = await compressImage(capturedBlob);

  try {
    const res = await fetch('/api/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ order_number: order, category, vendor, image_b64: b64 })
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);

    hideLoading();
    document.getElementById('beepAudio').play().catch(() => {});
    showToast('âœ… Record saved successfully!', 'success');
    resetForm();
    loadScorecard();

    if (historyVisible) loadHistory();

  } catch(e) {
    hideLoading();
    showToast('âŒ Error: ' + e.message, 'error');
  }
}

// â”€â”€â”€ Compress Image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function compressImage(blob) {
  return new Promise(resolve => {
    const img = new Image();
    const url = URL.createObjectURL(blob);
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      const max = 800;
      if (w > max || h > max) {
        if (w > h) { h = Math.round(h * max / w); w = max; }
        else       { w = Math.round(w * max / h); h = max; }
      }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      const b64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
      URL.revokeObjectURL(url);
      resolve(b64);
    };
    img.src = url;
  });
}

// â”€â”€â”€ Reset Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetForm() {
  document.getElementById('orderSelect').value = '';
  document.getElementById('cvGrid').style.display = 'none';
  capturedBlob = null;
  hidePreview();
  if (currentMode === 'camera') {
    document.getElementById('camera-section').classList.add('show');
    startCamera();
  } else {
    document.getElementById('upload-section').classList.add('show');
    document.getElementById('fileInput').value = '';
  }
}

// â”€â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleHistory() {
  historyVisible = !historyVisible;
  const sec = document.getElementById('historySection');
  const btn = document.getElementById('historyBtn');
  sec.classList.toggle('show', historyVisible);
  btn.textContent = historyVisible ? 'ğŸ“œ Hide History' : 'ğŸ“œ History';
  if (historyVisible) loadHistory();
}

async function loadHistory() {
  document.getElementById('historyContent').innerHTML = '<div class="no-records">Loading...</div>';
  try {
    const res  = await fetch('/api/history');
    const data = await res.json();
    if (!data.success) throw new Error(data.error);

    if (!data.records.length) {
      document.getElementById('historyContent').innerHTML =
        '<div class="no-records">ğŸ“­ No records found for today.</div>';
      return;
    }

    const headers = Object.keys(data.records[0]);
    let html = `<div class="history-table-wrap"><table>
      <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
      <tbody>`;

    data.records.forEach(r => {
      html += '<tr>';
      headers.forEach(h => {
        const val = r[h] || '';
        if (h.toLowerCase().includes('image') && val.startsWith('http')) {
          html += `<td class="img-cell"><img src="${val}" onclick="window.open('${val}','_blank')" title="Click to view full"/></td>`;
        } else {
          html += `<td>${val}</td>`;
        }
      });
      html += '</tr>';
    });

    html += `</tbody></table></div>
      <p style="color:#888; font-size:0.85rem; margin-top:10px; text-align:right;">
        Total today: <strong style="color:white;">${data.records.length}</strong>
      </p>`;

    document.getElementById('historyContent').innerHTML = html;
  } catch(e) {
    document.getElementById('historyContent').innerHTML =
      `<div class="no-records">âŒ Error: ${e.message}</div>`;
  }
}

// â”€â”€â”€ UI Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 4000);
}

function showLoading(text = 'Saving...') {
  document.getElementById('loadingText').textContent = text;
  document.getElementById('loadingOverlay').classList.add('show');
  document.getElementById('saveBtn').disabled = true;
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('show');
  document.getElementById('saveBtn').disabled = false;
}
</script>
</body>
</html>
